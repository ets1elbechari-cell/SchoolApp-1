{% load static %}
<!-- templates/includes/sidebar.html -->
<nav id="site-sidebar" class="site-sidebar" aria-label="Main sidebar">
  <div class="sidebar-inner">
    <a class="brand" href="{% url 'home' %}">
      <img src="{% static 'quiz_app/schoollogo.png' %}" alt="Site logo" class="brand-img">
      <span class="brand-text">MyQuiz</span>
    </a>

    <ul class="side-links" id="side-links">
      <li>
        <a data-test="home-nav" href="{% url 'home' %}" class="side-link {% if home_url == request.path %}active{% endif %}" {% if home_url == request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üè†</span><span class="label">Home</span>
        </a>
      </li>

      <li>
        <a data-test="learn-nav" href="{{ learn_url }}" class="side-link {% if learn_url in request.path %}active{% endif %}" {% if learn_url in request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üìö</span><span class="label">Learn</span>
        </a>
      </li>

      <li>
        <a data-test="practice-nav" href="{{ practice_url }}" class="side-link {% if practice_url in request.path %}active{% endif %}" {% if practice_url in request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üß†</span><span class="label">Practice</span>
        </a>
      </li>

      <li>
        <a data-test="leaderboard-nav" href="{{ leaderboard_url }}" class="side-link {% if leaderboard_url in request.path %}active{% endif %}" {% if leaderboard_url in request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üèÜ</span><span class="label">Leaderboards</span>
        </a>
      </li>

      <li>
        <a data-test="shop-nav" href="{{ shop_url }}" class="side-link {% if shop_url in request.path %}active{% endif %}" {% if shop_url in request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üõçÔ∏è</span><span class="label">Shop</span>
        </a>
      </li>

      <li>
        <a data-test="subjects-nav" href="{{ subjects_url }}" class="side-link {% if subjects_url in request.path or add_subject_url in request.path %}active{% endif %}" {% if subjects_url in request.path or add_subject_url in request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">üìÇ</span><span class="label">Subjects</span>
        </a>
      </li>

      <li>
        <a data-test="add-subject" href="{{ add_subject_url }}" class="side-link {% if add_subject_url == request.path %}active{% endif %}" {% if add_subject_url == request.path %}aria-current="page"{% endif %}>
          <span class="icon" aria-hidden="true">‚ûï</span><span class="label">Add Subject</span>
        </a>
      </li>

      <li>
        <a data-test="profile-tab" href="{{ profile_url }}" class="side-link profile-link {% if profile_url in request.path %}active{% endif %}" {% if profile_url in request.path %}aria-current="page"{% endif %}>
          <span class="avatar" aria-hidden="true">{{ request.user.username|slice:":1"|upper }}</span>
          <span class="label">Profile</span>
        </a>
      </li>
    </ul>
    

    <div class="sidebar-footer">
      <button id="sidebar-toggle" class="sidebar-toggle" aria-expanded="true" aria-label="Collapse sidebar">‚óÄ</button>
      <div class="copyright">¬© {{ now.year }}</div>
    </div>
  </div>

  <style>
    :root{
      --green-white: #edf2e9;
      --jambalaya: #613c18;
      --mantis: #6fbe5e;
      --thatch: #b49c8c;

      /* Sidebar width: roughly 1/4 of desktop but clamped between min/max */
      --sidebar-width: clamp(220px, 24vw, 340px);
      --sidebar-collapsed-width: 72px;
      --content-gap: 24px;
      --shadow: 0 12px 30px rgba(16,16,16,0.08);
      --radius: 10px;
    }

    /* Sidebar */
    .site-sidebar{
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: linear-gradient(180deg, #ffffff 0%, var(--green-white) 100%);
      border-right: 1px solid rgba(97,60,24,0.06);
      box-shadow: var(--shadow);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      transition: width .22s ease, transform .22s ease;
      overflow: hidden;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    .site-sidebar.collapsed{
      width: var(--sidebar-collapsed-width);
    }

    .sidebar-inner{
      display:flex;
      flex-direction:column;
      height:100%;
      justify-content:space-between;
      padding:18px 12px;
      gap:10px;
    }

    /* Brand */
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--jambalaya);
      font-weight:800;
      margin-bottom:6px;
    }
    .brand-img{
      width:56px;
      height:56px;
      border-radius:10px;
      object-fit:cover;
      background: linear-gradient(180deg,var(--mantis), var(--jambalaya));
      box-shadow: 0 8px 16px rgba(97,60,24,0.06);
      flex-shrink:0;
    }
    .brand-text{
      font-size:1.05rem;
      color:var(--jambalaya);
      white-space:nowrap;
    }

    /* Links list */
    .side-links{
      list-style:none;
      margin:8px 0 0 0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .side-link{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:8px;
      text-decoration:none;
      color:var(--jambalaya);
      font-weight:700;
      transition: background .12s, transform .08s;
    }
    .side-link:hover{ background: rgba(111,190,94,0.06); transform: translateX(2px); }
    .side-link[aria-current="page"], .side-link.active{
      background: linear-gradient(180deg,var(--mantis), #57a84a);
      color: white;
      box-shadow: 0 8px 18px rgba(111,190,94,0.14);
    }

    .icon{ font-size:18px; display:inline-block; width:28px; text-align:center; }
    .label{ display:inline-block; white-space:nowrap; }

    /* avatar */
    .avatar{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;
      height:36px;
      border-radius:8px;
      background: linear-gradient(180deg,var(--thatch), rgba(0,0,0,0.03));
      color:var(--jambalaya);
      font-weight:700;
      font-size:0.95rem;
    }

    /* Footer */
    .sidebar-footer{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      padding-top:8px;
    }
    .sidebar-toggle{
      border:0;
      background:transparent;
      font-weight:800;
      cursor:pointer;
      color:var(--jambalaya);
      padding:6px 8px;
      border-radius:8px;
    }
    .sidebar-toggle:hover{ background: rgba(97,60,24,0.04); }

    /* Collapsed state: hide labels, shrink brand text */
    .site-sidebar.collapsed .label,
    .site-sidebar.collapsed .brand-text{
      display:none;
    }
    .site-sidebar.collapsed .brand-img{
      width:44px;
      height:44px;
    }
    .site-sidebar.collapsed .side-link{
      justify-content:center;
      padding:10px 6px;
    }

    /* Make sure page content doesn't sit under the sidebar.
       You'll also set this in base.html body style (see instructions). */
    main, #content {
      transition: margin-left .22s ease;
    }

    /* Small screens: sidebar becomes a top drawer */
    @media (max-width: 860px){
      :root{ --sidebar-width: 100%; }
      .site-sidebar{
        height: var(--sidebar-width); /* using var so we can animate as top bar */
        width:100%;
        left:0;
        top:0;
        right:0;
        bottom:auto;
        flex-direction:row;
        align-items:center;
        padding:10px;
      }
      .site-sidebar.collapsed{ height:56px; }
      .sidebar-inner{ flex-direction:row; align-items:center; gap:10px; width:100%; justify-content:space-between; }
      .side-links{
        flex-direction:row;
        gap:6px;
        overflow:auto;
        padding-left:6px;
      }
      .side-link{ padding:8px; }
      /* On mobile we won't apply left margin to content; base template should reset padding-left on small screens */
    }
  </style>

  <script>
    (function(){
      const sidebar = document.getElementById('site-sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      const content = document.getElementById('content') || document.querySelector('main');

      if(!sidebar) return;

      // Set initial collapsed state based on localStorage
      const stored = localStorage.getItem('sidebar-collapsed');
      if(stored === 'true') sidebar.classList.add('collapsed');

      // Update content margin to avoid overlay (desktop only)
      function updateContentMargin(){
        if(window.matchMedia('(min-width:861px)').matches){
          const width = sidebar.classList.contains('collapsed')
            ? getComputedStyle(document.documentElement).getPropertyValue('--sidebar-collapsed-width').trim()
            : getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width').trim();
          if(content) content.style.marginLeft = width;
        } else {
          if(content) content.style.marginLeft = '';
        }
      }
      updateContentMargin();

      // Toggle button
      if(toggle){
        toggle.addEventListener('click', () => {
          const collapsed = sidebar.classList.toggle('collapsed');
          localStorage.setItem('sidebar-collapsed', collapsed ? 'true' : 'false');
          toggle.textContent = collapsed ? '‚ñ∂' : '‚óÄ';
          updateContentMargin();
        });
      }

      // If content exists but margin was empty on load, call again after fonts/images load
      window.addEventListener('load', updateContentMargin);

      // Update margin on resize
      window.addEventListener('resize', updateContentMargin);
    })();
  </script>
</nav>
